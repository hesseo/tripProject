<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
<style type="text/css">
body {
	line-height: 1.3em;
}

.history-tl-container {
	font-family: "Roboto", sans-serif;
	margin: auto;
	display: block;
	position: relative;
}

#tl {
	margin: 20px 0;
	padding: 0;
	display: inline-block;
}

.tl-item {
	list-style: none;
	margin: auto;
	margin-left: 200px;
	min-height: 50px;
	border-left: 3px solid #DF7600;
	padding: 0 0 50px 30px;
	position: relative;
}

.tl-item:last-child {
	border-left: 0;
}

.tl-item:last-child:before {
	left: 1.5px;
}

.tl-item::before {
	background: #FFFFFF none repeat scroll 0 0;
	border: 3px solid #DF7600;
	border-radius: 50%;
	content: " ";
	height: 18px;
	left: 0px;
	position: absolute;
	top: -5px;
	transition: all 500ms ease-in-out 0s;
	width: 18px;
	transform: translateX(-50%); /* X축 가운데 정렬 */
}

.tl-days::before {
	background: #FF9000 none repeat scroll 0 0;
	border: 3px solid #DF7600;
	border-radius: 50%;
	content: " ";
	height: 30px;
	left: 0px;
	position: absolute;
	top: -5px;
	transition: all 500ms ease-in-out 0s;
	width: 30px;
	transform: translateX(-50%); /* X축 가운데 정렬 */
}
.tl-days {
	color: orange;
	font-weight: bold;
	font-size: 16px;
	font-family: "Roboto",sans-serif;
}

.item-place {
	color: black;
	font-size: 14px;
}

.item-memo {
	color: rgba(0, 0, 0, 0.5);
	font-size: 12px;
}

.timestamp {
	color: #8D8D8D;
	position: absolute;
	width: 100px;
	left: -180%;
	text-align: right;
	font-size: 12px;
}
.btn {
	background-color: #FF9000;
	color: white;
	font-family: "Roboto",sans-serif;	
}
#addbtn {margin: 5%;}
.btn-xs {
	background-color: white;
	outline: 1px solid #ff9000;
	color: #ff9000;
	font-family: "Roboto",sans-serif;
}
.btn:hover { background-color: #DF7600; color: white; }
</style>
<script type="text/javascript">
	
	function convertToKoreanDateTime(utcDateString) {
        const date = new Date(utcDateString); // UTC 시간 변환
       
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, "0");

        const period = hours < 12 ? "오전" : "오후";
        hours = hours % 12 || 12; // 12시간제 변환 (0시는 12시로)

        return `${year}년 ${month}월 ${day}일 ${period} ${hours}시 ${minutes}분`;
    }
    
	function fetchTLData() {
		const body = document.querySelector("#tl");
		
		fetch("/planner/timelineJson")
		.then(response => {
			if(!response.ok) {
				throw new Error("네트워크 응답이 좋지 않습니다.");
			}
			return response.json();		// json 데이터를 객체로 변경 
		})
		.then(data => {
			if (data.items && data.items.length > 0) {
	            data.items.forEach(dto => {
	                make_timeline(dto);
	            });
	        } else {
	            body.textContent = "등록된 일정이 없습니다.";
	        }
			
		})
		.catch(err => {
			body.textContent = err.message;
		});
	}
	
	function make_timeline(dto) {
		let date = convertToKoreanDateTime(dto.datetime);
		
		const tl = document.getElementById('tl');
	    const tlItems = document.createElement('li');
	    
	    tlItems.innerHTML = `
	        <div class="timestamp">${date}</div>
	        <div class="item-title">${dto.title}</div>
	        <div class="item-memo">${dto.memo}</div>
	        <div class="button">
	        	<input class="btn btn-xs" type="button" value="삭제" onclick="onDelete('${dto.timelineSeq}')">
	        </div>
	    `;
	    tlItems.classList.add("tl-item");
	    tl.appendChild(tlItems);
	}
	
	function onDelete(datetime) {
		// alert(typeof datetime);
		if(confirm("삭제하시겠습니까?")) {
			// 서버에 삭제 요청 보내기 (GET 요청 또는 POST 요청으로 수정)
	        fetch(`/planner/deleteTimeline?timelineSeq=${dto.timelineSeq}`, {
	            method: 'GET',
	            redirect: 'follow'  // 리다이렉트 따르기
	        })
	        .then(response => {
	            if (response.ok) {
	                alert("삭제되었습니다.");
	             	// 삭제 후 UI에서 항목 제거
	                const itemToRemove = document.querySelector(`[data-timeline-seq="${dto.timelineSeq}"]`);
	                if (itemToRemove) {
	                    itemToRemove.remove();
	                }
	            } else {
	                throw new Error("삭제 실패");
	            }
	        })
	        .catch(error => {
	            console.error("Error deleting timeline:", error);
	            alert("삭제에 실패했습니다.");
	        });
			
		}
	}
	
	
	let openWin;
	function getMemo() {
		// form 요소에서 값을 가져오기
	    let startDate = encodeURIComponent(document.form1.startDate.value);
	    let endDate = encodeURIComponent(document.form1.endDate.value);
	    
	    // GET 방식으로 데이터 전달
	    let url = `addTimeline?startDate=${startDate}&endDate=${endDate}`;
		// window.open(url, "창이름", "브라우저 설정")
		openWin = window.open(url, "타임라인 추가", "width=500 height=700 left=500 top=200");
	}
	
	 // 자식 창에서 데이터 전송 시 호출됨
    window.addEventListener("message", function(event) {
        if (event.origin !== window.location.origin) return; // 보안 체크

        const receivedData = event.data;  // {"id': "aa", "place": "ㅁㄴㅇㄹ", "memo": "ㅁㄴㅇㄹ", "logtime": "2025-03-12T11:21"}
      	console.log("Rdata =", receivedData);
      	window.location.reload(true);
     	// 데이터를 서버로 전송
        fetch('/api/save-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(receivedData),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Data saved successfully:', data);
            make_timeline(data);
        })
        .catch(error => {
            console.error('Error saving data:', error);
        });
     }, false);
	 
	 
     document.addEventListener("DOMContentLoaded", function() {
    	fetchTLData();
        // Thymeleaf에서 값 가져오기
        let startDate = `[[${startDate}]]`;
        let endDate = `[[${endDate}]]`;
        
        // 값이 없으면 기본값 설정 (오늘 날짜)
        if (!startDate || startDate === "null") {
            startDate = moment().format("YYYY-MM-DD");
        }
        if (!endDate || endDate === "null") {
            endDate = moment().add(1, "days").format("YYYY-MM-DD");
        }
        
        // input value 설정
        document.querySelector('input[name="daterange"]').value = `${startDate} - ${endDate}`;

        // daterangepicker 초기화
        $('input[name="daterange"]').daterangepicker({
            locale: {
                format: 'YYYY-MM-DD'
            },
            startDate: startDate,
            endDate: endDate
        });
        
        inputNewTP();
    });
	
	function inputNewTP() {
		const dateRangeInput = document.querySelector('input[name="daterange"]');
	    const dateRange = dateRangeInput.value.split(" - ");
	    
	    if (dateRange.length !== 2) {
	        alert("올바른 날짜 범위를 선택하세요.");
	        return;
	    }
	    
	    const startDate = new Date(dateRange[0]);
	    const endDate = new Date(dateRange[1]);
	    
	    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) {
	        alert("올바른 날짜 범위를 선택하세요.");
	        return;
	    }
	    
	    const container = document.getElementById("tl");
	    container.innerHTML = ""; // 기존 내용 초기화
	    
	    const totalDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
	    
	    for (let i = 0; i < totalDays; i++) {
	        let currentDate = new Date(startDate);
	        currentDate.setDate(startDate.getDate() + i);
	        let formattedDate = currentDate.toISOString().split("T")[0];
	        
	        let tl_days = document.createElement("li");
	        tl_days.innerHTML = `<div class="days">${i + 1}일차</div>`;
	        tl_days.className = "tl-item tl-days";
	        container.appendChild(tl_days);
	    }
	}
	// 여행 기간 입력
	$(document).ready(function() {	
	    $('input[name="daterange"]').daterangepicker({
	        locale: {
	            format: 'YYYY-MM-DD'
	        }
	    });
	});
	function confirmNewTP() {
		if(confirm("새로운 여행 타임라인을 생성할까요?")) {
			const dateInput = $('input[name="daterange"]');

	        // daterangepicker가 이미 적용되어 있다면 제거 후 다시 설정
	        if (dateInput.data('daterangepicker')) {
	            dateInput.data('daterangepicker').remove();
	        }

	        // daterangepicker 초기화
	        dateInput.daterangepicker({
	            locale: {
	                format: 'YYYY-MM-DD'
	            }
	        });

	        // setTimeout을 사용하여 강제로 focus한 후 show() 실행
	        setTimeout(() => {
	            dateInput.data('daterangepicker').show();
	        }, 100);
		} else {
			return false;
		}
	}

</script>
</head>
<body>
	<form action="/planner/addTimeline" name="form1">
		<label for="daterange">여행 기간:</label>
		<input type="text" name="daterange" id="daterange" onclick="confirmNewTP()">
		<input type="button" class="btn" onclick="inputNewTP()" value="여행 기간 등록">
		
		<input type="hidden" name="startDate" th:value="${startDate}">
		<input type="hidden" name="endDate" th:value="${endDate}">
		
		<div class="history-tl-container">
			<ul id="tl">
				<li class="tl-item tl-days"></li>
				
			</ul>
			<br>
			<input id="addbtn" class="btn" type="button" value="추가" onclick="getMemo()">
		</div>
		
	</form>
</body>
</html>