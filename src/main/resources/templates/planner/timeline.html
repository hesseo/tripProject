
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />

<style type="text/css">
body {
	line-height: 1.3em;
}

.history-tl-container {
	font-family: "Roboto", sans-serif;
	margin: auto;
	display: block;
	position: relative;
}

#tl {
	margin: 20px 0;
	padding: 0;
	display: inline-block;
}

.tl-item {
	list-style: none;
	margin: auto;
	margin-left: 200px;
	min-height: 50px;
	border-left: 3px solid #DF7600;
	padding: 0 0 50px 30px;
	position: relative;
}

.tl-item:last-child {
	border-left: 0;
}

.tl-item:last-child:before {
	left: 1.5px;
}

.tl-item::before {
	background: #FFFFFF none repeat scroll 0 0;
	border: 3px solid #DF7600;
	border-radius: 50%;
	content: " ";
	height: 18px;
	left: 0px;
	position: absolute;
	top: -5px;
	transition: all 500ms ease-in-out 0s;
	width: 18px;
	transform: translateX(-50%); /* X축 가운데 정렬 */
}


.tl-days {
	color: orange;
	font-weight: bold;
	font-size: 16px;
	font-family: "Roboto",sans-serif;
}

.item-place {
	color: black;
	font-size: 14px;
}

.item-memo {
	color: rgba(0, 0, 0, 0.5);
	font-size: 12px;
}

.timestamp {
	color: #8D8D8D;
	position: absolute;
	width: 100px;
	left: -180%;
	text-align: right;
	font-size: 12px;
}
.btn {
	background-color: #FF9000;
	color: white;
	font-family: "Roboto",sans-serif;	
}
#addbtn {margin: 5%;}
.btn-xs {
	background-color: white;
	outline: 1px solid #ff9000;
	color: #ff9000;
	font-family: "Roboto",sans-serif;
}
.btn:hover { background-color: #DF7600; color: white; }

/* tab */
/* 탭 컨테이너 */
.nav-tabs {
  border-bottom: none;
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

/* 탭 아이템 */
.nav-tabs > li {
  margin: 0 5px;
  transition: all 0.3s ease;
}

/* 탭 링크 */
.nav-tabs > li > a {
  display: block;
  padding: 10px 20px;
  border-radius: 12px;
  background-color: #f9f9f9;
  color: #555;

  transition: all 0.3s ease;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  font-weight: 500;
}

/* 호버 시 */
.nav-tabs > li > a:hover {
  background-color: #ffe8cc;
  color: #d35400;
  border-color: #f0ad4e;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* 활성 탭 */
.nav-tabs > li.active > a,
.nav-tabs > li.active > a:focus,
.nav-tabs > li.active > a:hover {
  color: white;
  background-color: #ff9000;
  border: 1px solid #ff9000;
  border-bottom-color: transparent;
  box-shadow: 0 4px 10px rgba(255, 144, 0, 0.4);
  transform: translateY(-2px);
}

/* 부드러운 애니메이션 */
.nav-tabs > li > a, 
.nav-tabs > li.active > a {
  transition: all 0.3s ease;
}
</style>


<script type="text/javascript">
	//Thymeleaf에서 값 가져오기
	let startDate = `[[${startDate}]]`;
	let endDate = `[[${endDate}]]`;
	
	// 값이 없으면 기본값 설정 (오늘 날짜)
	if (!startDate || startDate === "null") {
	    startDate = moment().format("YYYY-MM-DD");
	}
	if (!endDate || endDate === "null") {
	    endDate = moment().add(1, "days").format("YYYY-MM-DD");
	}
	
	// 한국날짜 형식으로 변환해서 출력
	function convertToKoreanDateTime(utcDateString) {
        const date = new Date(utcDateString); // UTC 시간 변환
       
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, "0");

        const period = hours < 12 ? "오전" : "오후";
        hours = hours % 12 || 12; // 12시간제 변환 (0시는 12시로)

        return `${year}년 ${month}월 ${day}일 ${period} ${hours}시 ${minutes}분`;
    }
    
	function fetchTLData() {
		const body = document.querySelector("#tl");
		
		fetch("/planner/timelineJson")
		.then(response => {
			if(!response.ok) {
				throw new Error("네트워크 응답이 좋지 않습니다.");
			}
			return response.json();		// json 데이터를 객체로 변경 
		})
		.then(data => {
			if (data.items && data.items.length > 0) {
	            data.items.forEach(dto => {
	                make_timeline(dto);
	            });
	        } else {
	            body.textContent = "등록된 일정이 없습니다.";
	        }
			
		})
		.catch(err => {
			body.textContent = err.message;
		});
	}
	
	function make_timeline(dto) {
		let date = convertToKoreanDateTime(dto.datetime);
		
		const tl = document.getElementById('tl');
	    const tlItems = document.createElement('li');
	    
	    tlItems.innerHTML = `
	        <div class="timestamp">${date}</div>
	        <div class="item-title">${dto.title}</div>
	        <div class="item-memo">${dto.memo}</div>
	        <div class="button">
	        	<input class="btn btn-xs" type="button" value="삭제" onclick="onDelete('${dto.timelineSeq}')">
	        </div>
	    `;
	    tlItems.classList.add("tl-item");
	    tl.appendChild(tlItems);
	}
	
	function onDelete(timelineSeq) {
		// alert(typeof datetime);
		if(confirm("삭제하시겠습니까?")) {
			// 서버에 삭제 요청 보내기 (GET 요청 또는 POST 요청으로 수정)
	        fetch(`/planner/deleteTimeline?timelineSeq=${timelineSeq}`, {
	            method: 'GET',
	            redirect: 'follow'  // 리다이렉트 따르기
	        })
	        .then(response => {
	            if (response.ok) {
	                alert("삭제되었습니다.");
	             	// 삭제 후 UI에서 항목 제거
	                const itemToRemove = document.querySelector(`[data-timeline-seq="${timelineSeq}"]`);
	                if (itemToRemove) {
	                    itemToRemove.remove();
	                }
	            } else {
	                throw new Error("삭제 실패");
	            }
	        })
	        .catch(error => {
	            console.error("Error deleting timeline:", error);
	            alert("삭제에 실패했습니다.");
	        });
			
		}
	}
	
	
	let openWin;
	function getMemo() {
		inputNewTP();
		
	 	// moment.js를 사용하여 날짜 변환
	    const start_date = moment(startDate, "YYYY-MM-DD").format("YYYY-MM-DD");
	    const end_date = moment(endDate, "YYYY-MM-DD").format("YYYY-MM-DD");
	    
	    // hidden input에 값 설정
	    document.querySelector('input[name="startDate"]').value = start_date;
	    document.querySelector('input[name="endDate"]').value = end_date;

	    // GET 방식으로 데이터 전달
	    let url = "/planner/addTimeline?startDate=" + start_date + "&endDate=" + end_date;
		// window.open(url, "창이름", "브라우저 설정")
		openWin = window.open(url, "타임라인 추가", "width=500 height=700 left=500 top=200");
	}
	
	 // 자식 창에서 데이터 전송 시 호출됨
    window.addEventListener("message", function(event) {
        if (event.origin !== window.location.origin) return; // 보안 체크

        const receivedData = event.data;  // {"id': "aa", "title": "ㅁㄴㅇㄹ", "memo": "ㅁㄴㅇㄹ", "datetime": "2025-03-12T11:21"}
      	console.log("Rdata =", receivedData);
     	// 데이터를 서버로 전송
        fetch('/api/save-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(receivedData),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Data saved successfully:', data);
            make_timeline(data);
        })
        .catch(error => {
            console.error('Error saving data:', error);
            alert("저장 실패");
        });
     }, false);
	 
	 
     document.addEventListener("DOMContentLoaded", function() {
    	fetchTLData();
    });
	
	function inputNewTP() {
		
		
	    const tlTabContainer = document.querySelector(".nav-tabs");
	    tlTabContainer.innerHTML = ""; // 탭 초기화
	    
	    const ul = document.createElement("ul");
	    ul.className = "nav nav-tabs"
	    ul.style.listStyle = "none";
	    ul.style.padding = "0";
	    
	    const totalDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
	    
	    for (let i = 0; i < totalDays; i++) {
	        const li = document.createElement("li");
	        li.className= "nav-item"
	        li.style.display = "inline-block";
	        li.style.padding = "10px";
	        li.style.marginRight = "5px";
	        li.style.cursor = "pointer";
	        li.innerHTML = `<a class="nav-link active" aria-current="true">${i + 1}일차</a>`;
	        
	        ul.appendChild(li);
	    }
	    
	    tlTabContainer.appendChild(ul);
    }
	
	// 날짜 선택 범위 제한
	$(document).ready(function() {	
		
        // daterangepicker 초기화
        $('input[name="daterange"]').daterangepicker({
            locale: {
                format: 'YYYY-MM-DD'
            },
            startDate: startDate,
            endDate: endDate
        });
	});

</script>

<div id="container">
	<form action="/planner/addTimeline" name="form1">
		<input type="hidden" name="startDate">
		<input type="hidden" name="endDate">
		
		<div class="nav nav-tabs"></div>
		<div class="history-tl-container">
			<ul id="tl">
				
			</ul>
			<br>
			<input id="addbtn" class="btn" type="button" value="추가" onclick="getMemo()">
		</div>
	</form>
</div>
